<?xml version="1.0" encoding="iso-8859-1"?>

<!-- 
  Please see the license.html file included with this distribution for 
  attribution and copyright information.
-->

<root>

	<template name="label_charframetop">
		<metalplate>
			<frame name="metalplate" offset="10,2,10,2"/>
			<font>subwindowsmalltitle</font>
			<center />
			<nodrag />
			<readonly />
			<script file="campaign/scripts/char_labelframetop.lua" />
		</metalplate>
	</template>
	
	<template name="number_charstat">
		<number_stat>
			<anchored to="stats_label" width="60" height="30">
				<top anchor="top" />
				<left anchor="right" relation="relative" offset="18" />
			</anchored>
			<rollable />
			<!-- <script> -->
				<!-- function onInit() -->
					<!-- super.onInit(); -->
					<!-- onValueChanged(); -->
				<!-- end -->

				<!-- function onValueChanged() -->
					<!-- if getValue() > 85 then -->
						<!-- setValue(85); -->
						<!-- ChatManager.SystemMessage(Interface.getString("char_error_maxstat")); -->
					<!-- end -->
				<!-- end -->
			<!-- </script> -->
		</number_stat>
	</template>

	<template name="number_charstress">
		<number_stat>
			<anchored to="stress_label" width="60" height="30">
				<top anchor="top" />
				<left anchor="right" relation="relative" offset="18" />
			</anchored>
		</number_stat>
	</template>

	<template name="number_charhealth">
		<number_stat>
			<anchored to="health_label" width="60" height="30">
				<top anchor="top" />
				<left anchor="right" relation="relative" offset="18" />
			</anchored>
		</number_stat>
	</template>

	<template name="number_charcredits">
		<basicnumber>
			<anchored to="credits_label" width="60" height="20">
				<top anchor="top" offset="25" />
				<left anchor="right" relation="relative" offset="18" />
			</anchored>
			<default>0</default>
		</basicnumber>
	</template>

	<template name="number_bleeding">
		<number_charhealth>
			<rollable />
			<script file="campaign/scripts/number_bleeding.lua" />
		</number_charhealth>
	</template>

	<template name="number_stress">
		<number_charstress>
			<rollable />
			<script file="campaign/scripts/number_stress.lua" />
		</number_charstress>
	</template>

	<template name="number_rest">
		<number_charstress>
			<rollable />
			<script file="campaign/scripts/number_rest.lua" />
		</number_charstress>
	</template>

	<template name="number_charsave">
		<number_stat>
			<anchored to="saves_label" width="60" height="30">
				<top anchor="top" />
				<left anchor="right" relation="relative" offset="18" />
			</anchored>
			<rollable />
			<!-- <script> -->
				<!-- function onInit() -->
					<!-- super.onInit(); -->
					<!-- onValueChanged(); -->
				<!-- end -->

				<!-- function onValueChanged() -->
					<!-- if getValue() > 85 then -->
						<!-- setValue(85); -->
						<!-- ChatManager.SystemMessage(Interface.getString("char_error_maxsave")); -->
					<!-- end -->
				<!-- end -->
			<!-- </script> -->
		</number_stat>
	</template>

<!-- 	<template name="number_charsavetotal">
		<number_charsave>
			<frame name="fieldlight" offset="7,5,7,5" />
		</number_charsave>
	</template>
 -->
	<template name="number_charskill">
		<basicnumber>
			<anchored width="40" height="20" />
			<delaykeyupdate />
			<hideonvalue>0</hideonvalue>
			<nodrag />
			<!-- <displaysign /> -->
		</basicnumber>
	</template>
	
	<template name="number_charskilltotal">
		<number_linked>
			<anchored width="40" height="20" />
			<!-- <frame name="fieldlight" offset="7,5,7,5" /> -->
			<frame name="fieldlight_ms" offset="7,5,7,5" />
			<rollable />
			<script>
				function onInit()
					local nodeChar = window.getDatabaseNode().getChild("...");
					DB.addHandler(DB.getPath(nodeChar, "stats.*"), "onUpdate", onSourceUpdate);

					addSource("stat", "string");
					addSourceWithOp("bonus", "+");

					super.onInit();
				end
				
				function onClose()
					local nodeChar = window.getDatabaseNode().getChild("...");
					DB.removeHandler(DB.getPath(nodeChar, "stats.*"), "onUpdate", onSourceUpdate);
				end

				function onSourceUpdate(node)
					local nValue = calculateSources();

					local nodeSkill = window.getDatabaseNode();
					local nodeChar = nodeSkill.getChild("...");

					local sStat = DB.getValue(nodeSkill, "stat", ""):lower();
					if sStat ~= "" then
						local nStat = DB.getValue(nodeChar, "stats." .. sStat, 0)
						nValue = nValue + nStat;
					end
					
					setValue(nValue);
				end
				
				function action(draginfo)
					local nodeSkill = window.getDatabaseNode();
					local nodeChar = nodeSkill.getChild("...");
					--[[local rActor = ActorManager.getActor("pc", nodeChar);]]
					local rActor = ActorManager.resolveActor(nodeChar);

					local sStat = DB.getValue(nodeSkill, "stat", "");
					local sSkill = DB.getValue(nodeSkill, "name", "");

					--[[MothershipRoller.performAction(draginfo, rActor, getDatabaseNode().getValue() .. " " .. StringManager.capitalize(sStat) .. " [" .. sSkill .. "] check");]]
					local rAction = CharManagerMothership.buildCheckAction(rActor, sStat, getDatabaseNode().getValue(), sSkill);
					ActionCheck.performRoll(draginfo, rActor, rAction);
					return true;
				end
				
				function onDragStart(button, x, y, draginfo)
					return action(draginfo);
				end
					
				function onDoubleClick(x,y)
					return action();
				end
			</script>
		</number_linked>
	</template>

	<template name="cycler_ability">
		<button_stringcycler>
			<parameters>
				<defaultlabelres mergerule="replace">dash</defaultlabelres>
				<labelsres>str|spd|int|com</labelsres>
				<values>strength|speed|intellect|combat</values>
			</parameters>
		</button_stringcycler>
	</template>

	<template name="cycler_ability_full">
		<button_stringcycler>
			<parameters>
				<!-- <defaultlabelres mergerule="replace">dash</defaultlabelres> -->
				<labelsres>strength|speed|intellect|combat</labelsres>
				<values>Strength|Speed|Intellect|Combat</values>
			</parameters>
		</button_stringcycler>
	</template>

	<template name="cycler_skillbonus">
		<button_stringcycler>
			<parameters>
				<defaultlabelres mergerule="replace">untrainedbonus</defaultlabelres>
				<labelsres>trainedbonus|expertbonus|masterbonus</labelsres>
				<values>10|15|20</values>
			</parameters>
		</button_stringcycler>
	</template>

	<template name="cycler_skillrank">
		<button_stringcycler>
			<parameters>
				<labelsres>trainedrank|expertrank|masterrank</labelsres>
				<values>Trained|Expert|Master</values>
			</parameters>
			<script>
				function cycleLabel(bBackward)
					super.cycleLabel(bBackward);
					if super.getValue() == super.getEmptyValue() then
						super.cycleLabel(bBackward);
					end
				end
			</script>
		</button_stringcycler>
	</template>

	<!-- <template name="cycler_crit"> -->
		<!-- <button_stringcycler> -->
			<!-- <parameters> -->
				<!-- <defaultlabelres mergerule="replace">dash</defaultlabelres> -->
				<!-- <labelsres>bluntforce|bleeding|gunshot|fireandexplosives|goreandmassive</labelsres> -->
				<!-- <values>bluntforce|bleeding|gunshot|fireandexplosives|goreandmassive</values> -->
			<!-- </parameters> -->
		<!-- </button_stringcycler> -->
	<!-- </template> -->

	<template name="cycler_itemtype">
		<button_stringcycler>
			<parameters>
				<!-- <defaultlabelres mergerule="replace">dash</defaultlabelres> -->
				<labelsres>armor|weapon|equipment|loadout</labelsres>
				<values>Armor|Weapon|Equipment|Loadout</values>
			</parameters>
		</button_stringcycler>
	</template>
	
	<!-- <template name="cycler_abilitybase"> -->
		<!-- <cycler_ability> -->
			<!-- <parameters> -->
				<!-- <defaultlabelres mergerule="replace">base</defaultlabelres> -->
			<!-- </parameters> -->
		<!-- </cycler_ability> -->
	<!-- </template> -->

	<template name="list_charinv">
		<windowlist>
			<child></child>
			<child><backcolor>1A40301E</backcolor></child>
			<datasource>.inventorylist</datasource>
			<class>char_invitem</class>
			<allowdelete />
			<script file="campaign/scripts/char_invlist.lua" />
		</windowlist>
	</template>

	<template name="list_charweapon">
		<windowlist>
			<datasource>.weaponlist</datasource>
			<sortby><control>name</control></sortby>
			<!-- <allowcreate /> -->
			<!-- <allowdelete /> -->
			<script file="campaign/scripts/char_weaponlist.lua" />
		</windowlist>
	</template>

	<template name="list_condition">
		<list_text>
			<datasource>.conditionlist</datasource>
			<class>char_condition</class>
			<sortby><control>condition</control></sortby>
			<newfocus>condition</newfocus>
			<allowcreate />
			<allowdelete />
			<script>
				function onDrop(x, y, draginfo)
					local sDragType = draginfo.getType();
					if sDragType == "string" or sDragType == "condition" then
						local w = addEntry(true);
						w.condition.setValue(draginfo.getStringData());
						return true;
					end
				end
			</script>
		</list_text>
	</template>

	<template name="scrollbar_charcontents">
		<scrollbar>
			<anchored to="contents" offset="-5,-10"/>
			<target>contents</target>
		</scrollbar>
	</template>

	<template name="state_charammocounter">
		<buttongroup_counter>
			<sourcefields>
				<maximum>maxammo</maximum>
				<current>ammo</current>
			</sourcefields>
		</buttongroup_counter>
	</template>

	<template name="portrait_charlocal">
		<portraitselectioncontrol>
			<base>portraittoken_base</base>
			<mask>portraittoken_mask</mask>
			<script>
				function canModify()
					return window.getDatabaseNode().isReadOnly();
				end
				
				function onInit()
					local portraitfile = User.getLocalIdentityPortrait(window.getDatabaseNode());
					if portraitfile then
						setFile(portraitfile);
					end
				end
				
				function onClickDown(button, x, y)
					return true;
				end
				
				function onClickRelease(button, x, y)
					if not window.getDatabaseNode().isReadOnly() then
						local nodeChar = window.getDatabaseNode();
						if nodeChar then
							local wnd = Interface.openWindow("portraitselection", "");
							if wnd then
								wnd.SetLocalNode(nodeChar);
							end
						end
					end
				end
			</script>
		</portraitselectioncontrol>
	</template>

</root>
